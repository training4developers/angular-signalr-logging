<div ng-app="DemoApp">
	<div ng-controller="HomeCtrl">
		{{message}}
	</div>
	<div my-dir></div>
</div>

@section scripts {

	<!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
	<!--Reference the SignalR library. -->
	<script src="~/Scripts/jquery-2.2.1.min.js"></script>
	<script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0/angular.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.4.1/q.js"></script>

	<!--Reference the autogenerated SignalR hub script. -->
	<script src="~/signalr/hubs"></script>

	<!--SignalR script to update the chat page and send messages.-->
	<script>

		angular.module("DemoApp", [])
			.factory("socketLogger", function () {


				function getHubPromise() {
					var d = Q.defer();
					$.connection.hub.start().done(function () {
						d.resolve($.connection.loggerHub);
					});
					return d.promise;
				}

				var hubPromise = getHubPromise();

				//var hubPromise = new Promise(function (resolve, reject) {
				//	$.connection.hub.start().done(function () {
				//		resolve($.connection.loggerHub);
				//	});
				//});

				return {
					info: function (msg) {
						hubPromise.then(function(logger) {
							logger.server.info(msg);
						});
					},
					error: function(msg) {
						hubPromise.then(function (logger) {
							logger.server.error(msg);
						});
					}
				}
					
			})
			.directive("myDir", function () {

				return {
					priority: 10,
					link: function (scope, element) {
						element.html("Hi Class 2!");
					},
					cch: 2
				};

			})
			.directive("myDir", function () {

				return {
					priority: 42,
					link: function (scope, element) {
						element.html("Hi Class 1!");
					},
					cch: 1
				};

			})
			.config(function ($provide) {

				$provide.decorator("myDirDirective", function($delegate) {

					console.dir($delegate);

					return $delegate;
				});


			})
			.config(function ($provide) {

				$provide.decorator("$log", function ($delegate, socketLogger) {

					var originalErrorFn = $delegate.error;

					$delegate.error = function (msg) {

						originalErrorFn(msg);
						socketLogger.error(msg);

					};

					return $delegate;

				});


			})
			.controller("HomeCtrl", function (socketLogger, $scope, $log) {
				$scope.message = "This is fun!";
				socketLogger.info("this is a test!");

				$log.error("this is a an error!");
			});


	</script>
}
